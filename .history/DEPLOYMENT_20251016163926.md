# üöÄ Guide de D√©ploiement - TikTok Crossposter

Ce guide vous explique comment d√©ployer l'application TikTok Crossposter sur Vercel et Firebase.

## üìã Pr√©requis

- Compte Firebase/Google Cloud
- Compte Vercel
- Node.js 18+
- Yarn
- Firebase CLI
- Vercel CLI

## üîß Configuration

### 1. Variables d'environnement

Cr√©ez un fichier `.env.local` avec les variables suivantes :

```env
# Firebase Configuration
NEXT_PUBLIC_FIREBASE_API_KEY=your_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_app_id
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=your_measurement_id

# Google Cloud Configuration
GCP_PROJECT=your_project_id
GCP_LOCATION=europe-west1
TASK_QUEUE=publish-queue
PUBLISH_ENDPOINT=https://publish-tiktok-xxxxxxxx-ew.a.run.app
TASK_SA=tasks-invoker@your_project.iam.gserviceaccount.com
BUCKET_NAME=your_bucket_name

# TikTok Business API
TIKTOK_CLIENT_ID=your_tiktok_client_id
TIKTOK_CLIENT_SECRET=your_tiktok_client_secret
TIKTOK_REDIRECT_URI=https://your_domain.com/api/auth/tiktok/callback

# Encryption
ENCRYPTION_KEY=your_32_byte_base64_key
```

### 2. Configuration Firebase

```bash
# Initialiser Firebase
firebase login
firebase init

# Activer les services requis
gcloud services enable firestore.googleapis.com
gcloud services enable storage.googleapis.com
gcloud services enable cloudfunctions.googleapis.com
gcloud services enable cloudtasks.googleapis.com
```

### 3. Configuration Cloud Tasks

```bash
# Cr√©er la queue Cloud Tasks
gcloud tasks queues create publish-queue --location=europe-west1

# Cr√©er le service account
gcloud iam service-accounts create tasks-invoker \
  --display-name="Cloud Tasks Invoker"

# Donner les permissions
gcloud run services add-iam-policy-binding publishTikTok \
  --member=serviceAccount:tasks-invoker@your_project.iam.gserviceaccount.com \
  --role=roles/run.invoker --region=europe-west1
```

## üöÄ D√©ploiement

### Option 1: Script automatique

```bash
./scripts/deploy.sh
```

### Option 2: D√©ploiement manuel

#### 1. Build et test

```bash
# Installer les d√©pendances
yarn install

# Ex√©cuter les tests
yarn test:ci

# Build du projet
yarn build
```

#### 2. D√©ployer Firebase

```bash
# D√©ployer les r√®gles et index
firebase deploy --only firestore:rules,firestore:indexes,storage:rules

# D√©ployer les Cloud Functions
cd functions
yarn install
yarn build
cd ..
firebase deploy --only functions
```

#### 3. D√©ployer sur Vercel

```bash
# Installer Vercel CLI
npm i -g vercel

# D√©ployer
vercel --prod
```

## üîç V√©rification

### 1. V√©rifier Firebase

- [ ] Firestore rules d√©ploy√©es
- [ ] Storage rules d√©ploy√©es
- [ ] Cloud Functions d√©ploy√©es
- [ ] Cloud Tasks queue cr√©√©e

### 2. V√©rifier Vercel

- [ ] Application accessible
- [ ] Variables d'environnement configur√©es
- [ ] API routes fonctionnelles

### 3. Tests de bout en bout

- [ ] Connexion Google fonctionne
- [ ] Upload de vid√©o fonctionne
- [ ] Connexion TikTok fonctionne
- [ ] Planification fonctionne

## üõ†Ô∏è Maintenance

### Mise √† jour des Cloud Functions

```bash
cd functions
yarn build
firebase deploy --only functions
```

### Mise √† jour de l'application

```bash
yarn build
vercel --prod
```

### Monitoring

- **Firebase Console** : Logs et m√©triques
- **Vercel Dashboard** : Performance et erreurs
- **Google Cloud Console** : Cloud Tasks et Functions

## üö® D√©pannage

### Erreurs courantes

1. **Cloud Tasks non autoris√©**
   - V√©rifier les permissions du service account
   - V√©rifier l'URL de la Cloud Function

2. **Firestore rules bloqu√©es**
   - V√©rifier les r√®gles dans Firebase Console
   - Tester avec l'√©mulateur local

3. **Variables d'environnement manquantes**
   - V√©rifier la configuration Vercel
   - Red√©ployer apr√®s ajout de variables

### Logs utiles

```bash
# Logs Firebase Functions
firebase functions:log

# Logs Vercel
vercel logs

# Logs Cloud Tasks
gcloud logging read "resource.type=cloud_tasks_queue"
```

## üìä Monitoring et Alertes

Configurez des alertes pour :
- Erreurs de publication TikTok
- √âchecs de Cloud Tasks
- Utilisation excessive de Storage
- Erreurs d'authentification

## üîí S√©curit√©

- [ ] R√®gles Firestore restrictives
- [ ] R√®gles Storage s√©curis√©es
- [ ] Tokens TikTok chiffr√©s
- [ ] Variables d'environnement s√©curis√©es
- [ ] HTTPS forc√©
- [ ] CORS configur√©

## üìà Optimisation

- [ ] Cache des requ√™tes Firestore
- [ ] Compression des vid√©os
- [ ] CDN pour les assets statiques
- [ ] Monitoring des performances
- [ ] Alertes de co√ªts

---

üéâ **F√©licitations !** Votre application TikTok Crossposter est maintenant d√©ploy√©e et pr√™te √† l'emploi !
